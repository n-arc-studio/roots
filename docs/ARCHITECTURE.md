# Roots アーキテクチャ概要

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                         Frontend                            │
│         React + TypeScript + Vite + Tailwind CSS           │
│                                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  Home    │  │  Tree    │  │ Timeline │  │ Profile  │  │
│  │  Page    │  │  Page    │  │   Page   │  │   Page   │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Services & State Management             │  │
│  │  (Zustand, React Query, API Client, Web3)           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ REST API / WebSocket
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       Backend API                           │
│           Node.js + Express + TypeScript                    │
│                                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │   Auth   │  │  Person  │  │  Memory  │  │    AI    │  │
│  │  Routes  │  │  Routes  │  │  Routes  │  │  Routes  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                    Services                          │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐      │  │
│  │  │    IPFS    │ │ Blockchain │ │   OpenAI   │      │  │
│  │  │  Service   │ │   Service  │ │  Service   │      │  │
│  │  └────────────┘ └────────────┘ └────────────┘      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
         │              │                      │
         │              │                      │
         ▼              ▼                      ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────────┐
│  PostgreSQL  │  │    Redis     │  │   IPFS Node      │
│   Database   │  │    Cache     │  │ (Distributed FS) │
└──────────────┘  └──────────────┘  └──────────────────┘
                         │
                         ▼
              ┌──────────────────────┐
              │   Blockchain Network │
              │  (Polygon/Ethereum)  │
              │                      │
              │  Smart Contracts:    │
              │  - RootsRegistry     │
              └──────────────────────┘
```

## データフロー

### 人物登録フロー

1. **ユーザー入力** → フロントエンド
2. **データ整形** → バックエンドAPI
3. **IPFS保存** → IPFSサービス（返り値: hash）
4. **ブロックチェーン登録** → スマートコントラクト（personId + IPFS hash）
5. **PostgreSQL保存** → メタデータとインデックス
6. **レスポンス** → フロントエンド

### 思い出取得フロー

1. **リクエスト** → バックエンドAPI
2. **キャッシュ確認** → Redis
3. **PostgreSQLクエリ** → メタデータ取得
4. **IPFS取得** → IPFSから完全データ
5. **キャッシュ保存** → Redis
6. **レスポンス** → フロントエンド

## コンポーネント詳細

### フロントエンド

#### 主要ページ
- **HomePage**: ランディングページ、機能紹介
- **FamilyTreePage**: D3.jsによる家系図可視化
- **TimelinePage**: 時系列での家族史表示
- **ProfilePage**: 個人の詳細情報

#### サービス
- **apiClient**: REST APIクライアント
- **web3Service**: ブロックチェーン接続
- **storageService**: ローカルストレージ管理

### バックエンド

#### サービス層
- **AIService**: OpenAI API統合
- **IPFSService**: IPFS操作
- **BlockchainService**: スマートコントラクト操作
- **AuthService**: 認証・認可
- **DatabaseService**: DB操作抽象化

#### ミドルウェア
- **errorHandler**: エラーハンドリング
- **authMiddleware**: JWT検証
- **rateLimiter**: レート制限
- **validator**: リクエスト検証

### ブロックチェーン

#### RootsRegistry コントラクト

主要機能:
- `registerPerson()`: 人物をブロックチェーンに登録
- `registerMemory()`: 思い出を登録
- `updatePerson()`: 人物情報更新（作成者のみ）
- `getPerson()`: 人物情報取得
- `getUserPersons()`: ユーザーが作成した人物一覧

## セキュリティ考慮事項

1. **認証**: JWT + bcrypt
2. **データ検証**: Joi スキーマバリデーション
3. **Rate Limiting**: express-rate-limit
4. **CORS**: 適切なオリジン設定
5. **環境変数**: 機密情報の安全な管理
6. **HTTPS**: 本番環境では必須

## スケーラビリティ

1. **キャッシング**: Redis による頻繁アクセスデータのキャッシュ
2. **CDN**: 静的アセットの配信
3. **負荷分散**: 複数バックエンドインスタンス
4. **データベース最適化**: インデックス、クエリ最適化
5. **IPFS**: 分散ストレージによる負荷分散

## 将来の拡張

- [ ] リアルタイム通知（WebSocket）
- [ ] 高度な検索機能（Elasticsearch）
- [ ] モバイルアプリ（React Native）
- [ ] 多言語対応（i18n）
- [ ] アクセス権限管理（プライベート/公開）
- [ ] 家族グループ機能
- [ ] NFTによるデジタル遺産
